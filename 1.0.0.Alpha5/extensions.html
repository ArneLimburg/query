<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 5. Extending CDI Query</title><link rel="stylesheet" href="css/cambridge.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="CDI Query Module"/><link rel="up" href="index.html" title="CDI Query Module"/><link rel="prev" href="annotations.html" title="Chapter 4. Query Annotations"/><link rel="next" href="criteria.html" title="Chapter 6. JPA Criteria API Support"/></head><body><p id="title"><a href="http://www.ctp-consulting.com" class="site_href"><strong>Cambridge Technology Partners</strong></a><a href="http://www.ctp-consulting.com" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="annotations.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="criteria.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="extensions"/>Chapter 5. Extending CDI Query</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="extensions.html#extension-delegates">5.1. Query Delegates</a></span></dt><dd><dl><dt><span class="section"><a href="extensions.html#extension-impl">5.1.1. Implementing the Query Delegate</a></span></dt><dt><span class="section"><a href="extensions.html#extension-impl">5.1.2. Using the DAO Extension</a></span></dt></dl></dd><dt><span class="section"><a href="extensions.html#extensions-querydsl">5.2. Including Querydsl</a></span></dt></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="extension-delegates"/>5.1. Query Delegates</h2></div></div></div><p>
            While CDI Query defines several base interfaces, there might still be one or 
            another convenience method that is missing. This is actually intentional - 
            things should not get overloaded for each and every use case. That's why in
            CDI Query you can define your own reusable methods.
        </p><p>
            For example, you might want to refresh an entity immediately after you've
            flushed it to the database (e.g. because a trigger fired and updated your entity).
            You might want to define the following method on a base DAO:
        </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;E&nbsp;saveAndRefresh</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">E&nbsp;entity</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">entity</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">flush</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">refresh</span><span class="java_separator">(</span><span class="java_plain">entity</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>
            This method is generic enough that you can use it in all your DAOs. You can now
            mixin this method in your DAOs with a simple mechanism.
        </p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="extension-impl"/>5.1.1. Implementing the Query Delegate</h3></div></div></div><p>
                The first step is to define an interface which contains all the extra methods
                for your DAOs:
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">interface</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DaoExtension</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">E</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;saveAndRefresh</span><span class="java_separator">(</span><span class="java_plain">E&nbsp;entity</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;</span><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>
                As a next step, you need to provide an implementation for this interface
                once. It's also important that this implementation implements the
                <code class="literal">DelegateQueryHandler</code> interface (don't worry, this is)
                just an empty marker interface):
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_keyword">public</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DelegateDaoExtension</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">E</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">implements</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DaoExtension</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">E</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DelegateQueryHandler</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Inject</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">QueryInvocationContext</span><span class="java_plain">&nbsp;context</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Override</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;E&nbsp;saveAndRefresh</span><span class="java_separator">(</span><span class="java_plain">E&nbsp;entity</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">().</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">entity</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">().</span><span class="java_plain">flush</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entityManager</span><span class="java_separator">().</span><span class="java_plain">refresh</span><span class="java_separator">(</span><span class="java_plain">entity</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;entity</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;context</span><span class="java_separator">.</span><span class="java_plain">getEntityManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>
                As you see in the sample, you can inject a <code class="literal">QueryInvocationContext</code>
                which contains utility methods like accessing the current 
                <code class="literal">EntityManager</code> and entity class.
            </p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="extension-impl"/>5.1.2. Using the DAO Extension</h3></div></div></div><p>
                To use your newly created functionality, your DAOs can now be written like
            </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Dao</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">interface</span><span class="java_plain">&nbsp;</span><span class="java_type">SimpleDao</span><span class="java_plain">&nbsp;</span><span class="java_keyword">extends</span><span class="java_plain">&nbsp;</span><span class="java_type">DaoExtension</span><span class="java_operator">&lt;</span><span class="java_type">Simple</span><span class="java_operator">&gt;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">EntityDao</span><span class="java_operator">&lt;</span><span class="java_type">Simple</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_separator">}</span><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></pre><p>
                Note that, if you define multiple extensions with equivalent method signatures,
                there is no specific order in which the implementation is selected.
            </p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="extensions-querydsl"/>5.2. Including Querydsl</h2></div></div></div><p>
            CDI Query contains basic support for the Querydsl framework for JPA. Implementing
            the <code class="literal">QueryDslSupport</code> interface (and including the Querydsl 
            dependencies) gives you access to a <code class="code">JPAQuery</code> handle.
        </p><p>
            You can find more information about Querydsl on the <a class="ulink" href="http://www.querydsl.com/">website</a>.
        </p></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="annotations.html"><strong>Prev</strong>Chapter 4. Query Annotations</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="criteria.html"><strong>Next</strong>Chapter 6. JPA Criteria API Support</a></li></ul></body></html>